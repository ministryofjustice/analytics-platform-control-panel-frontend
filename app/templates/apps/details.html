{% extends "layouts/one-column.html" %}

{% set page_title = "App: " + app.name %}

{% block main_column %}


<h2 class="heading-medium">Description</h2>
<p>
  {{ app.description if app.description else "None" }}
</p>

<h2 class="heading-medium">Repo</h2>
<p>
  {% if app.repo_url %}
    <a href="{{ app.repo_url }}">{{ app.repo_url }}</a>
  {% else %}
    None
  {% endif %}
</p>

<!--
TODO: hook up app users properly to this once @jmoz has finished work to
      provide more info than just an array of IDs
-->
<h2 class="heading-medium">App users</h2>
{% if app.users.length %}
  <ul class="list list-bullet">
    {% for user in app.users %}
      <li>
        <a href="{{ url_for('user.details', {id: user.id}) }}">{{ user.name }}</a>
        {% if user.admin %}
          (Admin)
        {% endif %}
      </li>
    {% endfor %}
  </ul>
{% else %}
  <p>None</p>
{% endif %}
<!--
TODO: provide form to add users â€“ also dependent on the above work from @jmoz
 -->

<h2 class="heading-medium">App data sources</h2>
<p>{{ app.apps3buckets.length }} app data source{%- if app.apps3buckets.length != 1 -%}s{%- endif %} connected to this app</p>

{% if app.apps3buckets.length %}
  <table class="form-group">
    <thead>
      <tr>
        <th>Name</th>
        <th>App has read/write access</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {% for apps3bucket in app.apps3buckets %}
        <tr>
          <td><a href="{{ url_for('buckets.details', {id: apps3bucket.s3bucket.id}) }}">{{ apps3bucket.s3bucket.name }}</a></td>
          <td>{% if apps3bucket.access_level == 'readwrite' %}Yes{% else %}No{% endif %}</td>
          <td class="align-right">
            <!-- Button to change access level -->
            <form action="{{ url_for('apps3buckets.update', {id: apps3bucket.id}) }}" method="post" class="inline-form clearfix">
              <input type="hidden" name="access_level" value="{% if apps3bucket.access_level == 'readwrite' %}readonly{% else %}readwrite{% endif %}">

              <input type="hidden" name="redirect_to" value="{{ url_for('apps.details', {id: app.id}) }}">

              <input type="submit" class="js-confirm button button-secondary right" value="{% if apps3bucket.access_level == 'readwrite' %}Revoke{% else %}Grant{% endif %} read/write access" />
            </form>

            <!-- Button to revoke access -->
            <form action="{{ url_for('apps3buckets.delete', {id: apps3bucket.id}) }}" method="post" class="inline-form clearfix">
              <input type="hidden" name="redirect_to" value="{{ url_for('apps.details', {id: app.id}) }}">

              <input type="submit" class="js-confirm button button-warning right" value="Revoke access" />
            </form>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% else %}
  <p>None</p>
{% endif %}

{% if buckets_options.length %}
  <form action="{{ url_for('apps3buckets.create') }}" method="post">
    <input type="hidden" name="app_id" value="{{ app.id }}" />
    <div class="form-group">
      <label class="form-label" for="bucket_id">Connect an app data source</label>
      <select class="form-control no-blank" id="bucket_id" name="bucket_id">
        <option value="">Select app data source</option>
        {% for bucket in buckets_options %}
          <option value="{{ bucket.id }}">{{ bucket.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="form-group">
      <input type="submit" class="button button-secondary" value="Grant access">
    </div>
  </form>
{% else %}
  <p>(All available app data sources are already connected to this app.)</p>
{% endif %}


<hr>

<!-- only show if signed in user has admin rights to this app -->
<form action="{{ url_for('apps.delete', {id: app.id}) }}" method="post" class="clearfix">
  <input type="submit" class="button button-warning right js-confirm" value="Delete app" data-confirm-message="Are you sure you want to delete this app?">
</form>
<!-- end -->


{% endblock %}
